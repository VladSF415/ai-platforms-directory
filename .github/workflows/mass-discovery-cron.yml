name: Mass Discovery Cron

on:
  schedule:
    # Run every 4 hours (6 times per day = 1800 platforms/day)
    - cron: '0 */4 * * *'  # Every 4 hours
  workflow_dispatch:  # Allow manual trigger

jobs:
  mass-discovery:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Run Mass Discovery
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ðŸš€ Starting mass discovery..."
          echo "Time: $(date)"

          BEFORE_COUNT=$(node -e "console.log(require('./platforms.json').length)")
          echo "Current platforms: $BEFORE_COUNT"

          # Run mass discovery
          node scripts/mass-discovery.mjs --batch=25 --batches=12 --workers=3

          AFTER_COUNT=$(node -e "console.log(require('./platforms.json').length)")
          ADDED=$((AFTER_COUNT - BEFORE_COUNT))

          echo "âœ… Discovery complete!"
          echo "Added: $ADDED platforms"
          echo "Total: $AFTER_COUNT platforms"

          echo "ADDED=$ADDED" >> $GITHUB_ENV
          echo "TOTAL=$AFTER_COUNT" >> $GITHUB_ENV

      - name: Commit and Push Changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add platforms.json MASS_DISCOVERY_REPORT.md || true

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "GitHub Actions: +${{ env.ADDED }} platforms (total: ${{ env.TOTAL }})

Automated mass discovery via GitHub Actions cron
- Added: ${{ env.ADDED }} new platforms
- Total: ${{ env.TOTAL }} platforms
- Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code) - GitHub Actions

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

          git push

      - name: Trigger Railway Deployment
        run: |
          echo "âœ… Changes pushed to GitHub"
          echo "Railway will auto-deploy the new platforms.json"
          echo "Live site will update in ~2 minutes"
